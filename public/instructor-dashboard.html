<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iLearn - Instructor Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      body {
        background: #f5f7fb;
        min-height: 100vh;
      }

      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 5%;
        background: white;
        border-bottom: 1px solid #eee;
      }

      .brand {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1a1a1a;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        align-items: center;
      }

      .nav-links a {
        text-decoration: none;
        color: #4285f4;
      }

      .profile-badge {
        width: 32px;
        height: 32px;
        background: #f0f0f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        color: #666;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 5%;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .stat-card .number {
        font-size: 2rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
      }

      .stat-card .detail {
        font-size: 0.875rem;
        color: #4285f4;
      }

      .quick-actions {
        margin-bottom: 2rem;
      }

      .quick-actions h2 {
        font-size: 1.2rem;
        color: #1a1a1a;
        margin-bottom: 1rem;
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        cursor: pointer;
        border: none;
        font-weight: 500;
      }

      .btn-primary {
        background: #4285f4;
        color: white;
      }

      .btn-outline {
        background: white;
        border: 1px solid #4285f4;
        color: #4285f4;
      }

      .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .course-card {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .course-image {
        height: 160px;
        background: #f0f0f0;
      }

      .course-content {
        padding: 1.5rem;
      }

      .course-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
      }

      .course-stats {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #666;
        font-size: 0.875rem;
        margin-bottom: 1rem;
      }

      .edit-btn {
        padding: 0.5rem 1.5rem;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.875rem;
      }

      .activity-section {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .activity-section h2 {
        font-size: 1.2rem;
        color: #1a1a1a;
        margin-bottom: 1rem;
      }

      .activity-item {
        padding: 1rem 0;
        border-bottom: 1px solid #eee;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-text {
        color: #1a1a1a;
        margin-bottom: 0.25rem;
      }

      .activity-time {
        color: #666;
        font-size: 0.875rem;
      }

      .analytics-section {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .analytics-section h2 {
        font-size: 1.2rem;
        color: #1a1a1a;
        margin-bottom: 1rem;
      }

      .chart-container {
        height: 300px;
        background: #f8f9fa;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 600px;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
      }
    </style>
  </head>
  <body>
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-database-compat.min.js"></script>

    <!-- Dashboard Content -->
    <nav class="navbar">
      <div class="brand">E-Learning Platform</div>
      <div class="nav-links">
        <a href="#" class="active">Dashboard</a>
        <a href="#">My Courses</a>
        <a href="#">Messages</a>
        <div class="profile-badge" id="profileInitials">JD</div>
      </div>
    </nav>

    <div class="container">
      <div class="stats-grid" id="statsGrid">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="openCreateCourseModal()">
            Create Course
          </button>
          <button class="btn btn-outline" onclick="startLiveSession()">
            Live Session
          </button>
        </div>
      </div>

      <h2>My Courses</h2>
      <div class="courses-grid" id="coursesGrid">
        <!-- Courses will be populated by JavaScript -->
      </div>

      <div class="activity-section">
        <h2>Recent Activity</h2>
        <div id="activityFeed">
          <!-- Activity feed will be populated by JavaScript -->
        </div>
      </div>

      <div class="analytics-section">
        <h2>Analytics</h2>
        <div class="chart-container" id="analyticsChart">
          <!-- Analytics chart will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Create Course Modal -->
    <div class="modal" id="createCourseModal">
      <div class="modal-content">
        <h2>Create New Course</h2>
        <form id="createCourseForm">
          <div class="form-group">
            <label for="courseTitle">Course Title</label>
            <input type="text" id="courseTitle" required />
          </div>
          <div class="form-group">
            <label for="courseDescription">Description</label>
            <textarea id="courseDescription" required></textarea>
          </div>
          <div class="form-group">
            <label for="coursePrice">Price ($)</label>
            <input type="number" id="coursePrice" required />
          </div>
          <button type="submit" class="btn btn-primary">Create Course</button>
          <button
            type="button"
            class="btn btn-outline"
            onclick="closeCreateCourseModal()"
          >
            Cancel
          </button>
        </form>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
        authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
        databaseURL: process.env.REACT_APP_FIREBASE_DATABASE_URL,
        projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
        storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
        messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
        appId: process.env.REACT_APP_FIREBASE_APP_ID,
        measurementId: process.env.REACT_APP_FIREBASE_MEASUREMENT_ID,
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const database = firebase.database();

      // Instructor Dashboard Class
      class InstructorDashboard {
        constructor(userId) {
          this.userId = userId;
          this.userData = null;
          this.courses = [];
          this.initialize();
        }

        async initialize() {
          await this.loadUserData();
          await this.loadCourses();
          this.updateUI();
          this.setupRealTimeListeners();
        }

        async loadUserData() {
          const snapshot = await database
            .ref(`users/${this.userId}`)
            .once("value");
          this.userData = snapshot.val();
          document.getElementById("profileInitials").textContent =
            this.userData.fullName
              .split(" ")
              .map((n) => n[0])
              .join("");
        }

        async loadCourses() {
          const snapshot = await database
            .ref("courses")
            .orderByChild("instructorId")
            .equalTo(this.userId)
            .once("value");
          this.courses = snapshot.val() || {};
        }

        async createCourse(courseData) {
          const courseRef = database.ref("courses").push();
          const course = {
            ...courseData,
            instructorId: this.userId,
            createdAt: Date.now(),
            status: "active",
          };
          await courseRef.set(course);
          return courseRef.key;
        }

        async updateCourseStats() {
          const stats = {
            totalStudents: 0,
            activeCourses: 0,
            totalRevenue: 0,
            averageRating: 0,
            totalRatings: 0,
          };

          for (const courseId in this.courses) {
            const course = this.courses[courseId];
            const enrollmentsSnapshot = await database
              .ref(`enrollments/${courseId}`)
              .once("value");
            const enrollments = enrollmentsSnapshot.val() || {};

            stats.totalStudents += Object.keys(enrollments).length;
            stats.activeCourses++;
            stats.totalRevenue +=
              course.price * Object.keys(enrollments).length;

            if (course.ratings) {
              const ratings = Object.values(course.ratings);
              stats.totalRatings += ratings.length;
              stats.averageRating += ratings.reduce(
                (sum, rating) => sum + rating,
                0
              );
            }
          }

          if (stats.totalRatings > 0) {
            stats.averageRating /= stats.totalRatings;
          }

          return stats;
        }

        updateUI() {
          this.updateStats();
          this.updateCoursesGrid();
          this.updateActivityFeed();
          this.updateAnalytics();
        }

        async updateStats() {
          const stats = await this.updateCourseStats();
          document.getElementById("statsGrid").innerHTML = `
                    <div class="stat-card">
                        <h3>Total Students</h3>
                        <div class="number">${stats.totalStudents}</div>
                        <div class="detail">+12% from last month</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Courses</h3>
                        <div class="number">${stats.activeCourses}</div>
                        <div class="detail">2 courses pending review</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="number">$${stats.totalRevenue}</div>
                        <div class="detail">+8% from last month</div>
                    </div>
                    <div class="stat-card">
                        <h3>Average Rating</h3>
                        <div class="number">${stats.averageRating.toFixed(
                          1
                        )}</div>
                        <div class="detail">Based on ${
                          stats.totalRatings
                        } reviews</div>
                    </div>
                `;
        }

        updateCoursesGrid() {
          const coursesHTML = Object.entries(this.courses)
            .map(
              ([id, course]) => `
                    <div class="course-card">
                        <div class="course-image"></div>
                        <div class="course-content">
                            <div class="course-title">${course.title}</div>
                            <div class="course-stats">
                                <span>${
                                  course.enrollments
                                    ? Object.keys(course.enrollments).length
                                    : 0
                                } Students</span>
                                <span>• ${course.rating || 0} ⭐</span>
                            </div>
                            <button class="edit-btn" onclick="editCourse('${id}')">Edit</button>
                        </div>
                    </div>
                `
            )
            .join("");

          document.getElementById("coursesGrid").innerHTML = coursesHTML;
        }

        async updateActivityFeed() {
          const activities = [];
          for (const courseId in this.courses) {
            const enrollmentsSnapshot = await database
              .ref(`enrollments/${courseId}`)
              .limitToLast(5)
              .once("value");
            const ratingsSnapshot = await database
              .ref(`courses/${courseId}/ratings`)
              .limitToLast(5)
              .once("value");

            const enrollments = enrollmentsSnapshot.val() || {};
            const ratings = ratingsSnapshot.val() || {};

            Object.entries(enrollments).forEach(([userId, enrollment]) => {
              activities.push({
                type: "enrollment",
                courseId,
                courseName: this.courses[courseId].title,
                timestamp: enrollment.enrolledAt,
              });
            });

            Object.entries(ratings).forEach(([userId, rating]) => {
              activities.push({
                type: "rating",
                courseId,
                courseName: this.courses[courseId].title,
                rating,
                timestamp: rating.timestamp,
              });
            });
          }

          activities.sort((a, b) => b.timestamp - a.timestamp);

          document.getElementById("activityFeed").innerHTML = activities
            .map(
              (activity) => `
                    <div class="activity-item">
                        <div class="activity-text">
                            ${
                              activity.type === "enrollment"
                                ? `New enrollment in "${activity.courseName}"`
                                : `New ${activity.rating}⭐ rating on "${activity.courseName}"`
                            }
                        </div>
                        <div class="activity-time">${this.formatTimeAgo(
                          activity.timestamp
                        )}</div>
                    </div>
                `
            )
            .join("");
        }

        updateAnalytics() {
          // Implement analytics visualization here
          // You might want to use a charting library like Chart.js
        }

        formatTimeAgo(timestamp) {
          const seconds = Math.floor((Date.now() - timestamp) / 1000);
          if (seconds < 60) return "just now";
          const minutes = Math.floor(seconds / 60);
          if (minutes < 60)
            return `${minutes} minute${minutes !== 1 ? "s" : ""} ago`;
          const hours = Math.floor(minutes / 60);
          if (hours < 24) return `${hours} hour${hours !== 1 ? "s" : ""} ago`;
          const days = Math.floor(hours / 24);
          return `${days} day${days !== 1 ? "s" : ""} ago`;
        }

        setupRealTimeListeners() {
          // Listen for new enrollments
          database.ref("enrollments").on("child_changed", () => {
            this.loadCourses().then(() => this.updateUI());
          });

          // Listen for new ratings
          database.ref("courses").on("child_changed", () => {
            this.loadCourses().then(() => this.updateUI());
          });
        }
      }

      // Auth state observer
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const userData = await database
            .ref(`users/${user.uid}`)
            .once("value");
          const userType = userData.val()?.userType;

          if (userType === "instructor") {
            // Initialize dashboard
            new InstructorDashboard(user.uid);
          } else {
            // Redirect to appropriate page
            window.location.href = "/login.html";
          }
        } else {
          // User is signed out
          window.location.href = "/login.html";
        }
      });

      // Modal functions
      function openCreateCourseModal() {
        document.getElementById("createCourseModal").classList.add("active");
      }

      function closeCreateCourseModal() {
        document.getElementById("createCourseModal").classList.remove("active");
      }

      // Initialize event listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Create course form handler
        document
          .getElementById("createCourseForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const courseData = {
              title: document.getElementById("courseTitle").value,
              description: document.getElementById("courseDescription").value,
              price: parseFloat(document.getElementById("coursePrice").value),
              createdAt: Date.now(),
            };

            try {
              const dashboard = new InstructorDashboard(auth.currentUser.uid);
              await dashboard.createCourse(courseData);
              closeCreateCourseModal();
              location.reload();
            } catch (error) {
              console.error("Error creating course:", error);
              alert("Failed to create course. Please try again.");
            }
          });
      });
    </script>
  </body>
</html>
